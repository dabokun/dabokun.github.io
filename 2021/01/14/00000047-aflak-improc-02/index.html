<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>ほしよみ社会塵のブログ</title><meta name="description" content="やっていきます"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="

はじめに今回も前回に引き続き自作プログラムでベーシックな画像処理まがいのことをしていきます．今回のお品書きはこちらです．

カラーヒストグラム表示
RGB→HSV変換とHSV→RGBのマッピング
トーンカーブ機能の作成



その1. カラーヒストグラムの表示RGB 3チャンネルではなく1チャンネルのみのヒストグラムは既にできていたので，ちょちょっと改造です．カラー画像と認識したデータに対する出力の右側にヒストグラムを表示するようにしました．
123456789101112131415161718192021222324252627282930313233343536373839404142434445464748pub(crate) fn show_hist_color(&amp;amp;self, ui: .."><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="ほしよみ社会塵のブログ" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">ほしよみ社会塵のブログ</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">自作プログラムで画像処理（カラーヒストグラム表示～トーンカーブ作成まで）</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/null">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/null">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB"><span class="toc-text">はじめに</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%81%9D%E3%81%AE1-%E3%82%AB%E3%83%A9%E3%83%BC%E3%83%92%E3%82%B9%E3%83%88%E3%82%B0%E3%83%A9%E3%83%A0%E3%81%AE%E8%A1%A8%E7%A4%BA"><span class="toc-text">その1. カラーヒストグラムの表示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%81%9D%E3%81%AE2-RGB%E2%86%92HSV%E5%A4%89%E6%8F%9B"><span class="toc-text">その2. RGB→HSV変換</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E3%83%88%E3%83%BC%E3%83%B3%E3%82%AB%E3%83%BC%E3%83%96%E3%81%AE%E4%BD%9C%E6%88%90"><span class="toc-text">トーンカーブの作成</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/Rust"><i class="tag post-item-tag">Rust</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">自作プログラムで画像処理（カラーヒストグラム表示～トーンカーブ作成まで）</h1><time class="has-text-grey" datetime="2021-01-14T14:58:45.000Z">2021-01-14</time><article class="mt-2 post-content"><script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<h3 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h3><p>今回も<a href="/2021/01/04/00000046-aflak-improc-01/">前回</a>に引き続き自作プログラムでベーシックな画像処理まがいのことをしていきます．<br>今回のお品書きはこちらです．</p>
<ul>
<li><strong>カラーヒストグラム表示</strong></li>
<li><strong>RGB→HSV変換とHSV→RGBのマッピング</strong></li>
<li><strong>トーンカーブ機能の作成</strong></li>
</ul>
<span id="more"></span>

<h4 id="その1-カラーヒストグラムの表示"><a href="#その1-カラーヒストグラムの表示" class="headerlink" title="その1. カラーヒストグラムの表示"></a>その1. カラーヒストグラムの表示</h4><p>RGB 3チャンネルではなく1チャンネルのみのヒストグラムは既にできていたので，ちょちょっと改造です．カラー画像と認識したデータに対する出力の右側にヒストグラムを表示するようにしました．</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">pub</span>(<span class="keyword">crate</span>) <span class="keyword">fn</span> <span class="title function_">show_hist_color</span>(&amp;<span class="keyword">self</span>, ui: &amp;Ui, pos: [<span class="type">f32</span>; <span class="number">2</span>], size: [<span class="type">f32</span>; <span class="number">2</span>]) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">vmin</span> = <span class="number">0.0</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">vmax</span> = <span class="number">65535.0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> FILL_COLOR_R: <span class="type">u32</span> = <span class="number">0x5500_00FF</span>;</span><br><span class="line">  <span class="keyword">const</span> FILL_COLOR_G: <span class="type">u32</span> = <span class="number">0x5500_FF00</span>;</span><br><span class="line">  <span class="keyword">const</span> FILL_COLOR_B: <span class="type">u32</span> = <span class="number">0x55FF_0000</span>;</span><br><span class="line">  <span class="keyword">const</span> BORDER_COLOR: <span class="type">u32</span> = <span class="number">0xFF00_0000</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">hist</span> = <span class="keyword">self</span>.image.<span class="title function_ invoke__">hist_color</span>();</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>((max_count_r, max_count_g, max_count_b)) = hist</span><br><span class="line">      .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">      .<span class="title function_ invoke__">map</span>(|bin| (bin[<span class="number">0</span>].count, bin[<span class="number">1</span>].count, bin[<span class="number">2</span>].count))</span><br><span class="line">      .<span class="title function_ invoke__">max</span>()</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">draw_list</span> = ui.<span class="title function_ invoke__">get_window_draw_list</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">max_count</span> = max_count_r.<span class="title function_ invoke__">max</span>(max_count_g).<span class="title function_ invoke__">max</span>(max_count_b);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x_pos</span> = pos[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..<span class="number">3</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> <span class="variable">bin</span> <span class="keyword">in</span> hist &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">y_pos</span> = pos[<span class="number">1</span>] + size[<span class="number">1</span>] / (vmax - vmin) * (vmax - bin[i].start);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">y_pos_end</span> = pos[<span class="number">1</span>] + size[<span class="number">1</span>] / (vmax - vmin) * (vmax - bin[i].end);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">length</span> = size[<span class="number">0</span>]</span><br><span class="line">          * <span class="keyword">if</span> <span class="keyword">self</span>.hist_logscale &#123;</span><br><span class="line">            (bin[i].count <span class="keyword">as</span> <span class="type">f32</span>).<span class="title function_ invoke__">log10</span>() / (max_count <span class="keyword">as</span> <span class="type">f32</span>).<span class="title function_ invoke__">log10</span>()</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            (bin[i].count <span class="keyword">as</span> <span class="type">f32</span>) / (max_count <span class="keyword">as</span> <span class="type">f32</span>)</span><br><span class="line">          &#125;;</span><br><span class="line">          draw_list</span><br><span class="line">            .<span class="title function_ invoke__">add_rect</span>(</span><br><span class="line">              [x_pos + size[<span class="number">0</span>] - length, y_pos],</span><br><span class="line">              [x_pos + size[<span class="number">0</span>], y_pos_end],</span><br><span class="line">              <span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line">                FILL_COLOR_R</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> i == <span class="number">1</span> &#123;</span><br><span class="line">                FILL_COLOR_G</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                FILL_COLOR_B</span><br><span class="line">              &#125;,</span><br><span class="line">            )</span><br><span class="line">            .<span class="title function_ invoke__">filled</span>(<span class="literal">true</span>)</span><br><span class="line">            .<span class="title function_ invoke__">build</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    draw_list</span><br><span class="line">      .<span class="title function_ invoke__">add_rect</span>(pos, [pos[<span class="number">0</span>] + size[<span class="number">0</span>], pos[<span class="number">1</span>] + size[<span class="number">1</span>]], BORDER_COLOR)</span><br><span class="line">      .<span class="title function_ invoke__">build</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>するとこんな感じにカラー画像の横に出てきます．<br><img src="/tw01.jpg" alt="カラーヒストグラムの表示"></p>
<h4 id="その2-RGB→HSV変換"><a href="#その2-RGB→HSV変換" class="headerlink" title="その2. RGB→HSV変換"></a>その2. RGB→HSV変換</h4><p><a target="_blank" rel="noopener" href="https://www.peko-step.com/tool/hsvrgb.html">このサイト</a>によると，画素の RGB それぞれの輝度値$$R, G, B$$として，<br>$$Max &#x3D; \max(R, G, B), Min &#x3D; \min(R, G, B)$$<br>$$H &#x3D; 60 * ((G - B) &#x2F; (Max - Min)) ,; \max(R, G, B) &#x3D; R$$<br>$$H &#x3D; 60 * ((B - R) &#x2F; (Max - Min)) + 120 ,; \max(R, G, B) &#x3D; G$$<br>$$H &#x3D; 60 * ((R - G) &#x2F; (Max - Min)) + 240 ,; \max(R, G, B) &#x3D; B$$<br>$$S &#x3D; (Max - Min) &#x2F; Max$$<br>$$V &#x3D; Max$$<br>と計算できるっぽいのでこれに習っていきます．上の例だと色相は360度で表現してますが，後々 RGB に再マッピングすることを考えて 16bit の範囲に再スケールしておきます．</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">run_color_image_to_hsv</span>(image: &amp;WcsArray) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;IOValue, IOErr&gt; &#123;</span><br><span class="line">  dim_is!(image, <span class="number">3</span>)?;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">image</span> = image.<span class="title function_ invoke__">scalar</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">out</span> = image.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">  <span class="keyword">for</span> (j, slice) <span class="keyword">in</span> image.<span class="title function_ invoke__">axis_iter</span>(<span class="title function_ invoke__">Axis</span>(<span class="number">1</span>)).<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">    <span class="keyword">for</span> (i, data) <span class="keyword">in</span> slice.<span class="title function_ invoke__">axis_iter</span>(<span class="title function_ invoke__">Axis</span>(<span class="number">1</span>)).<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">hue</span> = <span class="number">0.0</span>;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">max</span> = data[<span class="number">0</span>].<span class="title function_ invoke__">max</span>(data[<span class="number">1</span>]).<span class="title function_ invoke__">max</span>(data[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">min</span> = data[<span class="number">0</span>].<span class="title function_ invoke__">min</span>(data[<span class="number">1</span>]).<span class="title function_ invoke__">min</span>(data[<span class="number">2</span>]);</span><br><span class="line">      <span class="keyword">if</span> data[<span class="number">0</span>] &gt;= data[<span class="number">1</span>] &amp;&amp; data[<span class="number">0</span>] &gt;= data[<span class="number">2</span>] &#123;</span><br><span class="line">        hue = <span class="number">60.0</span> * ((data[<span class="number">1</span>] - data[<span class="number">2</span>]) / (max - min));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> data[<span class="number">1</span>] &gt;= data[<span class="number">0</span>] &amp;&amp; data[<span class="number">1</span>] &gt;= data[<span class="number">2</span>] &#123;</span><br><span class="line">        hue = <span class="number">60.0</span> * ((data[<span class="number">2</span>] - data[<span class="number">0</span>]) / (max - min)) + <span class="number">120.0</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> data[<span class="number">2</span>] &gt;= data[<span class="number">0</span>] &amp;&amp; data[<span class="number">2</span>] &gt;= data[<span class="number">1</span>] &#123;</span><br><span class="line">        hue = <span class="number">60.0</span> * ((data[<span class="number">0</span>] - data[<span class="number">1</span>]) / (max - min)) + <span class="number">240.0</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Unreachable&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> hue &lt; <span class="number">0.0</span> &#123;</span><br><span class="line">        hue += <span class="number">360.0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      hue = hue / <span class="number">360.0</span> * <span class="number">65535.0</span>;</span><br><span class="line">      out[[<span class="number">0</span>, j, i]] = hue;</span><br><span class="line">      out[[<span class="number">1</span>, j, i]] = (max - min) / max * <span class="number">65535.0</span>;</span><br><span class="line">      out[[<span class="number">2</span>, j, i]] = max;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_ invoke__">Ok</span>(IOValue::<span class="title function_ invoke__">Image</span>(WcsArray::<span class="title function_ invoke__">from_array</span>(Dimensioned::<span class="title function_ invoke__">new</span>(</span><br><span class="line">    out,</span><br><span class="line">    Unit::<span class="literal">None</span>,</span><br><span class="line">  ))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>まずは HSV の値が入っている三次元データをスライスして見てみるとこんな感じの強度分布図になります．<br><img src="/01.jpg" alt="HSV の強度分布図"></p>
<p>上のビジュアルプログラムについて少し説明を書いておくと，<strong>まず上記の計算式から 0番目に色相のマップ，1番目に彩度のマップ，2番目に明度のマップが入っているような三次元データを作ります（図の赤枠）．この三次元データは右側に流れていき，スライスすることでそれぞれのマップデータ（二次元）を得ています．</strong></p>
<p>次にこれらをRGBに再マッピングしてみます．次のような，三つの二次元のチャンネルデータを受け取ってカラー画像（三次元データ）を出力するようなノードを作ります．</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">run_generate_color_image_from_channel</span>(</span><br><span class="line">    image_r: &amp;WcsArray,</span><br><span class="line">    image_g: &amp;WcsArray,</span><br><span class="line">    image_b: &amp;WcsArray,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;IOValue, IOErr&gt; &#123;</span><br><span class="line">  dim_is!(image_r, <span class="number">2</span>)?;</span><br><span class="line">  dim_is!(image_g, <span class="number">2</span>)?;</span><br><span class="line">  dim_is!(image_b, <span class="number">2</span>)?;</span><br><span class="line">  are_same_dim!(image_r, image_b)?;</span><br><span class="line">  are_same_dim!(image_b, image_g)?;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">dim</span> = image_r.<span class="title function_ invoke__">scalar</span>().<span class="title function_ invoke__">dim</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">dim</span> = dim.<span class="title function_ invoke__">as_array_view</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">colorimage</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">with_capacity</span>(<span class="number">3</span> * dim[<span class="number">0</span>] * dim[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">for</span> &amp;data <span class="keyword">in</span> image_r.<span class="title function_ invoke__">scalar</span>().<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">    colorimage.<span class="title function_ invoke__">push</span>(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> &amp;data <span class="keyword">in</span> image_g.<span class="title function_ invoke__">scalar</span>().<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">    colorimage.<span class="title function_ invoke__">push</span>(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> &amp;data <span class="keyword">in</span> image_b.<span class="title function_ invoke__">scalar</span>().<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">    colorimage.<span class="title function_ invoke__">push</span>(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">img</span> = Array::<span class="title function_ invoke__">from_shape_vec</span>((<span class="number">3</span>, dim[<span class="number">0</span>], dim[<span class="number">1</span>]), colorimage).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title function_ invoke__">Ok</span>(IOValue::<span class="title function_ invoke__">Image</span>(WcsArray::<span class="title function_ invoke__">from_array</span>(Dimensioned::<span class="title function_ invoke__">new</span>(</span><br><span class="line">    img.<span class="title function_ invoke__">into_dyn</span>(),</span><br><span class="line">    Unit::<span class="literal">None</span>,</span><br><span class="line">  ))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>とりあえずHをR，SをG，VをBにそのままマッピングすると次のようになりました．<strong>エッジの接続関係（下図の黄緑枠）を変えることで，別の組み合わせにする（たとえばHをB，SをR，VをGなど）ことも自由自在</strong>です．<br><img src="/02.jpg" alt="HSV→RGBへのマッピング"><br>上の図で，HをR，SをG，VをBに接続していることが表現されています．</p>
<h4 id="トーンカーブの作成"><a href="#トーンカーブの作成" class="headerlink" title="トーンカーブの作成"></a>トーンカーブの作成</h4><p>お次はトーンカーブ．ゼロから作らなければならなかったので，これが一番面倒でした．まずはインタフェースからのんびり作っていきます．</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Clone, Debug, Serialize, Deserialize, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">ToneCurveState</span> &#123;</span><br><span class="line">  arr: <span class="type">Vec</span>&lt;<span class="type">f32</span>&gt;,</span><br><span class="line">  cp: <span class="type">Vec</span>&lt;[<span class="type">f32</span>; <span class="number">2</span>]&gt;,</span><br><span class="line">  adding: <span class="type">Option</span>&lt;[<span class="type">f32</span>; <span class="number">2</span>]&gt;,</span><br><span class="line">  pushed: <span class="type">bool</span>,</span><br><span class="line">  moving: <span class="type">Option</span>&lt;<span class="type">usize</span>&gt;,</span><br><span class="line">  deleting: <span class="type">Option</span>&lt;<span class="type">usize</span>&gt;,</span><br><span class="line">  x_clicking: <span class="type">usize</span>,</span><br><span class="line">  is_dragging: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">ToneCurveState</span> &#123;</span><br><span class="line">  <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">default</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="comment">/*省略*/</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">control_points</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;[<span class="type">f32</span>; <span class="number">2</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">self</span>.cp</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">array</span>(<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">f32</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">self</span>.arr</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PartialEq</span> <span class="keyword">for</span> <span class="title class_">ToneCurveState</span> &#123;</span><br><span class="line">  <span class="keyword">fn</span> <span class="title function_">eq</span>(&amp;<span class="keyword">self</span>, val: &amp;<span class="keyword">Self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cp1</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">control_points</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">cp2</span> = val.<span class="title function_ invoke__">control_points</span>();</span><br><span class="line">    cp1 == cp2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">UiToneCurve</span> &#123;</span><br><span class="line">  <span class="keyword">fn</span> <span class="title function_">create_curve</span>(cp: &amp;<span class="type">Vec</span>&lt;[<span class="type">f32</span>; <span class="number">2</span>]&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">f32</span>&gt;;</span><br><span class="line">  <span class="keyword">fn</span> <span class="title function_">tone_curve</span>(</span><br><span class="line">    &amp;<span class="keyword">self</span>,</span><br><span class="line">    state: &amp;<span class="keyword">mut</span> ToneCurveState,</span><br><span class="line">    draw_list: &amp;WindowDrawList,</span><br><span class="line">  ) <span class="punctuation">-&gt;</span> io::<span class="type">Result</span>&lt;<span class="type">Option</span>&lt;ToneCurveState&gt;&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;<span class="symbol">&#x27;ui</span>&gt; UiToneCurve <span class="keyword">for</span> <span class="title class_">Ui</span>&lt;<span class="symbol">&#x27;ui</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">fn</span> <span class="title function_">create_curve</span>(cp: &amp;<span class="type">Vec</span>&lt;[<span class="type">f32</span>; <span class="number">2</span>]&gt;) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;<span class="type">f32</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/*省略*/</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">fn</span> <span class="title function_">tone_curve</span>(</span><br><span class="line">    &amp;<span class="keyword">self</span>,</span><br><span class="line">    state: &amp;<span class="keyword">mut</span> ToneCurveState,</span><br><span class="line">    draw_list: &amp;WindowDrawList,</span><br><span class="line">  ) <span class="punctuation">-&gt;</span> io::<span class="type">Result</span>&lt;<span class="type">Option</span>&lt;ToneCurveState&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">cursor_screen_pos</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">mouse_pos</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">io</span>().mouse_pos;</span><br><span class="line">    <span class="keyword">let</span> [mouse_x, mouse_y] = [mouse_pos[<span class="number">0</span>] - p[<span class="number">0</span>] - <span class="number">5.0</span>, mouse_pos[<span class="number">1</span>] - p[<span class="number">1</span>] - <span class="number">5.0</span>];</span><br><span class="line">    state.arr = <span class="keyword">Self</span>::<span class="title function_ invoke__">create_curve</span>(&amp;state.cp);</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">invisible_button</span>(im_str!(<span class="string">&quot;tone_curve&quot;</span>), [<span class="number">410.0</span>, <span class="number">410.0</span>]);</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">set_cursor_screen_pos</span>(p);</span><br><span class="line">    PlotLines::<span class="title function_ invoke__">new</span>(<span class="keyword">self</span>, im_str!(<span class="string">&quot;Tone Curve Test&quot;</span>), &amp;state.arr)</span><br><span class="line">        .<span class="title function_ invoke__">graph_size</span>([<span class="number">410.0</span>, <span class="number">410.0</span>])</span><br><span class="line">        .<span class="title function_ invoke__">scale_min</span>(<span class="number">0.0</span>)</span><br><span class="line">        .<span class="title function_ invoke__">scale_max</span>(<span class="number">256.0</span>)</span><br><span class="line">        .<span class="title function_ invoke__">build</span>();</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">set_cursor_screen_pos</span>(p);</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">invisible_button</span>(im_str!(<span class="string">&quot;tone_curve&quot;</span>), [<span class="number">410.0</span>, <span class="number">410.0</span>]);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(adding) = state.adding &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">x</span> = adding[<span class="number">0</span>] * <span class="number">400.0</span> + <span class="number">5.0</span> + p[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">y</span> = (<span class="number">1.0</span> - adding[<span class="number">1</span>]) * <span class="number">400.0</span> + <span class="number">5.0</span> + p[<span class="number">1</span>];</span><br><span class="line">      draw_list.<span class="title function_ invoke__">add_circle</span>([x, y], <span class="number">5.0</span>, <span class="number">0xFF00_FFFF</span>).<span class="title function_ invoke__">build</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">counter</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> &amp;state.cp &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">x</span> = i[<span class="number">0</span>] * <span class="number">400.0</span> + <span class="number">5.0</span> + p[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">let</span> <span class="variable">y</span> = (<span class="number">1.0</span> - i[<span class="number">1</span>]) * <span class="number">400.0</span> + <span class="number">5.0</span> + p[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">if</span> (x - mouse_pos[<span class="number">0</span>]) * (x - mouse_pos[<span class="number">0</span>]) + (y - mouse_pos[<span class="number">1</span>]) * (y - mouse_pos[<span class="number">1</span>])</span><br><span class="line">          &lt; <span class="number">25.0</span></span><br><span class="line">      &#123;</span><br><span class="line">        draw_list.<span class="title function_ invoke__">add_circle</span>([x, y], <span class="number">5.0</span>, <span class="number">0xFF00_00FF</span>).<span class="title function_ invoke__">build</span>();</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">is_mouse_clicked</span>(MouseButton::Left) &amp;&amp; state.adding == <span class="literal">None</span> &#123;</span><br><span class="line">          state.moving = <span class="title function_ invoke__">Some</span>(counter);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">is_mouse_clicked</span>(MouseButton::Right) &#123;</span><br><span class="line">          <span class="keyword">self</span>.<span class="title function_ invoke__">open_popup</span>(im_str!(<span class="string">&quot;delete-control-point&quot;</span>));</span><br><span class="line">          state.deleting = <span class="title function_ invoke__">Some</span>(counter);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        draw_list.<span class="title function_ invoke__">add_circle</span>([x, y], <span class="number">5.0</span>, <span class="number">0xFFFF_FFFF</span>).<span class="title function_ invoke__">build</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      counter += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">popup</span>(im_str!(<span class="string">&quot;delete-control-point&quot;</span>), || &#123;</span><br><span class="line">      <span class="keyword">if</span> MenuItem::<span class="title function_ invoke__">new</span>(im_str!(<span class="string">&quot;Delete Control Point&quot;</span>)).<span class="title function_ invoke__">build</span>(<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(key) = state.deleting &#123;</span><br><span class="line">          state.cp.<span class="title function_ invoke__">remove</span>(key);</span><br><span class="line">          state.deleting = <span class="literal">None</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">is_item_hovered</span>() &#123;</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">is_mouse_clicked</span>(MouseButton::Left) &amp;&amp; state.moving == <span class="literal">None</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> !state.is_dragging &#123;</span><br><span class="line">          state.is_dragging = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> state.is_dragging &#123;</span><br><span class="line">        <span class="keyword">if</span> state.pushed == <span class="literal">false</span> &#123;</span><br><span class="line">          state.pushed = <span class="literal">true</span>;</span><br><span class="line">          state.cp.<span class="title function_ invoke__">push</span>([mouse_x / <span class="number">400.0</span>, (<span class="number">400.0</span> - mouse_y) / <span class="number">400.0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        state.adding = <span class="title function_ invoke__">Some</span>([mouse_x / <span class="number">400.0</span>, (<span class="number">400.0</span> - mouse_y) / <span class="number">400.0</span>]);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">lastidx</span> = state.cp.<span class="title function_ invoke__">len</span>() - <span class="number">1</span>;</span><br><span class="line">        state.cp[lastidx] = state.adding.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">if</span> state.x_clicking &gt; <span class="number">255</span> &#123;</span><br><span class="line">          state.x_clicking = <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.<span class="title function_ invoke__">is_mouse_down</span>(MouseButton::Left) &#123;</span><br><span class="line">          state.cp.<span class="title function_ invoke__">sort_by</span>(|a, b| a[<span class="number">0</span>].<span class="title function_ invoke__">partial_cmp</span>(&amp;b[<span class="number">0</span>]).<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">          state.adding = <span class="literal">None</span>;</span><br><span class="line">          state.is_dragging = <span class="literal">false</span>;</span><br><span class="line">          state.pushed = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(key) = state.moving &#123;</span><br><span class="line">        state.cp[key] = [mouse_x / <span class="number">400.0</span>, (<span class="number">400.0</span> - mouse_y) / <span class="number">400.0</span>];</span><br><span class="line">        <span class="keyword">if</span> !<span class="keyword">self</span>.<span class="title function_ invoke__">is_mouse_down</span>(MouseButton::Left) &#123;</span><br><span class="line">          state.moving = <span class="literal">None</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">state</span> = state.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(<span class="title function_ invoke__">Some</span>(state))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><video src="tw01.mp4" width="674" height="360" controls></video><br>まだハードコードされているところとかがあり，要修正ですが貼っておきます．曲線の計算には現在 <a target="_blank" rel="noopener" href="http://naochang.me/?p=1119">Catmull-Rom Spline 曲線</a>を使っています．state にはコントロールポイントやルックアップテーブルの配列データ（現在大きさは256，0.0～256.0までの値が格納）が入っていて，次のように使います．</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable">tone_curve_state</span> = ui.<span class="title function_ invoke__">tone_curve</span>(&amp;<span class="keyword">mut</span> state, &amp;draw_list);</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Ok</span>(state) = tone_curve_state &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">state</span> = state.<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">control_points</span> = state.<span class="title function_ invoke__">control_points</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">array</span> = state.<span class="title function_ invoke__">array</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>次に，トーンカーブのデータ型を作って，画像データとトーンカーブデータから適用後の画像を出力するノードを作って完成です．<br>トーンカーブデータのところは省略します．</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">run_apply_tone_curve</span>(image: &amp;WcsArray, tone_curve: ToneCurveState) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;IOValue, IOErr&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">image_arr</span> = image.<span class="title function_ invoke__">scalar</span>().<span class="title function_ invoke__">clone</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">table</span> = tone_curve.<span class="title function_ invoke__">array</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">table_size</span> = table.<span class="title function_ invoke__">len</span>() - <span class="number">1</span>;</span><br><span class="line">  image_arr.<span class="title function_ invoke__">par_map_inplace</span>(|v| &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">key</span> = (*v * table_size <span class="keyword">as</span> <span class="type">f32</span> / <span class="number">65535.0</span>) <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">value</span> = <span class="number">65535.0</span> * table[key] / table_size <span class="keyword">as</span> <span class="type">f32</span>;</span><br><span class="line">    *v = value;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_ invoke__">Ok</span>(IOValue::<span class="title function_ invoke__">Image</span>(WcsArray::<span class="title function_ invoke__">from_array</span>(Dimensioned::<span class="title function_ invoke__">new</span>(</span><br><span class="line">    image_arr,</span><br><span class="line">    Unit::<span class="literal">None</span>,</span><br><span class="line">  ))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><video src="tw02.mp4" width="674" height="360" controls></video><br>ちなみに par_map_inplace という関数は ndarray_parallel という crate にあるもので，中の計算を並列処理してくれます．<br>普通に map で計算する場合と時間を比較するとこんな感じです．</p>
<p><img src="/tw02.png" alt="並列処理のコード">画像にて失礼…．</p>
<p><img src="/tw03.png" alt="実際にparallelのほうが速くなっている">実行結果はこんな漢字です．<br>結構速くなってますね．他にも直せるところがあると思っています．</p>
<p>さて，数日かけて色々とやりましたが次は何をしましょうか．悩み中です．しばらくは改善とリファクタリングですかね…．<br>なにか作って欲しいものやアドバイスがありましたらブログや Twitter で募集しております．<br>それでは．</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2021/02/09/00000048-fsq-ret-qhy268c/" title="ごほーこく"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: ごほーこく</span></a><a class="button is-default" href="/2021/01/04/00000046-aflak-improc-01/" title="自作プログラムで画像処理（Raw展開～ノイズ解析まで）"><span class="has-text-weight-semibold">Next: 自作プログラムで画像処理（Raw展開～ノイズ解析まで）</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="dabokun/dabokun.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/astrodabo"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/dabokun"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> dabokun 2025</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>