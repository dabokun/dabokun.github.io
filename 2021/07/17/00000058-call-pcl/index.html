<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>ほしよみ社会塵のブログ</title><meta name="description" content="やっていきます"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="あいさつこんにちは．突然ですが，皆さんは PixInsight Class Library（PCL）をご存知でしょうか．PixInsight 内部の機能がプログラムの形で提供されています．

The PixInsight Class Library (PCL) is a C++ development framework to build PixInsight modules.PixInsight modules are special shared libraries (.so files on FreeBSD and Linux; .dylib under macOS; .dll files on Windows) that communicate with the PixInsight core ap.."><meta property="og:url" content="http://dabokun.github.io/2021/07/17/00000058-call-pcl/"><meta property="og:title" content="ほしよみ社会塵のブログ"><meta property="og:type" content="article"><meta property="og:description" content="あいさつこんにちは．突然ですが，皆さんは PixInsight Class Library（PCL）をご存知でしょうか．PixInsight 内部の機能がプログラムの形で提供されています．

The PixInsight Class Library (PCL) is a C++ development framework to build PixInsight modules.PixInsight modules are special shared libraries (.so files on FreeBSD and Linux; .dylib under macOS; .dll files on Windows) that communicate with the PixInsight core application through a high-level API provided by PCL. Along with a core communication API, PCL includes a comprehensive set of image processing algorithms, ranging from geometrical transformations to multiscale analysis algorithms, most of them available as multithreaded parallel implementations. PCL provides also rigorous and efficient implementations of essential astronomical algorithms, including state-of-the-art solar system ephemerides, vector astrometry, and reduction of positions of solar system and stellar objects.PixInsight Class Library― by Pleiades Astrophoto S.L.

私は普段 Rust と呼ばれるちょっとモダンなプログラミング言語を使っているのですが，C++ との Foreign Function Interface（FFI）を学んでいるうちに，あれ，これ PCL も呼べるんじゃね？ということに気づいたので，せっかくならやってみることにしました．"><meta property="name" content="あいさつこんにちは．突然ですが，皆さんは PixInsight Class Library（PCL）をご存知でしょうか．PixInsight 内部の機能がプログラムの形で提供..."><meta property="og:image" content="http://dabokun.github.io/null"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@astrodabo"><meta property="og:site_name" content="ほしよみ社会塵のブログ"><meta property="og:locale" content="ja_JP"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="ほしよみ社会塵のブログ" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">ほしよみ社会塵のブログ</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">PixInsight Class Library を自作プログラムから呼び出してみる</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/null">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/null">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%81%82%E3%81%84%E3%81%95%E3%81%A4"><span class="toc-text">あいさつ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%82%84%E3%82%8A%E6%96%B9"><span class="toc-text">やり方</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%9F%E3%81%84%E6%A9%9F%E8%83%BD%E3%81%8C%E6%A0%BC%E7%B4%8D%E3%81%95%E3%82%8C%E3%81%9F%E3%82%B9%E3%82%BF%E3%83%86%E3%82%A3%E3%83%83%E3%82%AF%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E7%94%A8%E6%84%8F"><span class="toc-text">呼び出したい機能が格納されたスタティックライブラリを用意</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-%E5%81%B4%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%BF%E3%83%95%E3%82%A7%E3%83%BC%E3%82%B9%E3%82%92%E7%94%A8%E6%84%8F%EF%BC%8CPCL-%E3%81%A8%E3%83%AA%E3%83%B3%E3%82%AF%EF%BC%8CRust-%E3%83%90%E3%82%A4%E3%83%B3%E3%83%87%E3%82%A3%E3%83%B3%E3%82%B0%E3%81%AE%E8%87%AA%E5%8B%95%E7%94%9F%E6%88%90"><span class="toc-text">C++ 側のインタフェースを用意，PCL とリンク，Rust バインディングの自動生成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Rust-%E3%81%AE%E6%9C%AC%E7%95%AA%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8B%E3%82%89%E5%91%BC%E5%87%BA%E3%81%97"><span class="toc-text">Rust の本番アプリケーションから呼出し</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%81%BE%E3%81%A8%E3%82%81"><span class="toc-text">まとめ</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E7%94%BB%E5%83%8F%E5%87%A6%E7%90%86"><i class="tag post-item-tag">画像処理</i></a><a href="/tags/Rust"><i class="tag post-item-tag">Rust</i></a><a href="/tags/C++"><i class="tag post-item-tag">C++</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">PixInsight Class Library を自作プログラムから呼び出してみる</h1><time class="has-text-grey" datetime="2021-07-17T06:46:31.000Z">2021-07-17</time><article class="mt-2 post-content"><h3 id="あいさつ"><a href="#あいさつ" class="headerlink" title="あいさつ"></a>あいさつ</h3><p>こんにちは．突然ですが，皆さんは PixInsight Class Library（PCL）をご存知でしょうか．PixInsight 内部の機能がプログラムの形で提供されています．</p>
<blockquote>
<p>The PixInsight Class Library (PCL) is a C++ development framework to build PixInsight modules.<br>PixInsight modules are special shared libraries (.so files on FreeBSD and Linux; .dylib under macOS; .dll files on Windows) that communicate with the PixInsight core application through a high-level API provided by PCL. Along with a core communication API, PCL includes a comprehensive set of image processing algorithms, ranging from geometrical transformations to multiscale analysis algorithms, most of them available as multithreaded parallel implementations. PCL provides also rigorous and efficient implementations of essential astronomical algorithms, including state-of-the-art solar system ephemerides, vector astrometry, and reduction of positions of solar system and stellar objects.<br><a target="_blank" rel="noopener" href="https://pixinsight.com/developer/pcl/">PixInsight Class Library</a>― by Pleiades Astrophoto S.L.</p>
</blockquote>
<p>私は普段 Rust と呼ばれるちょっとモダンなプログラミング言語を使っているのですが，C++ との Foreign Function Interface（FFI）を学んでいるうちに，あれ，これ PCL も呼べるんじゃね？ということに気づいたので，せっかくならやってみることにしました．</p>
<span id="more"></span>

<h3 id="やり方"><a href="#やり方" class="headerlink" title="やり方"></a>やり方</h3><p>PCL には Hello World のようなサンプルがないので，PCL から Version を表示する機能を呼んでやることを目標にします．<br><img src="/01.jpg" alt="このへんのコードを呼び出したい">↑のような PCL のコードを呼び出したいです．</p>
<p>以下にやり方をつらつらと書いていきます．<br>OS は Windows 10 で，Git と Rust コンパイラ，CMake，Visual Studio（2019 Community）がインストールされていることが前提です．<br>Rust から C++ を呼ぶのは若干めんどくさく，</p>
<ol>
<li><p>呼び出したい機能が格納されたスタティックライブラリを用意する．</p>
</li>
<li><p>C++ 側のインタフェースを用意して，1.のライブラリとリンクしてビルドする．（今回はCMakeを使います）</p>
</li>
<li><p>C++ 側のヘッダーから Rust のバインディングを自動生成する．（bindgen crate を使います）</p>
</li>
<li><p>Rust の本番アプリケーションから呼び出す．</p>
</li>
</ol>
<p>みたいな流れになります．<br>2，3については，Rust の build script を使ってビルド時によしなにやってくれるようにします．<br>順番にやっていきましょう．</p>
<h4 id="呼び出したい機能が格納されたスタティックライブラリを用意"><a href="#呼び出したい機能が格納されたスタティックライブラリを用意" class="headerlink" title="呼び出したい機能が格納されたスタティックライブラリを用意"></a>呼び出したい機能が格納されたスタティックライブラリを用意</h4><p>呼び出したい機能が格納されたスタティックライブラリとは，PCL のことです．ただ，PCL はソースコードの形で提供されているため，頑張ってビルドします．<br>まず PCL リポジトリをクローン（ローカルにダウンロード）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://gitlab.com/pixinsight/PCL/</span><br></pre></td></tr></table></figure>
<p>PCLDIR, PCLBINDIR64, PCLLIBDIR64, PCLINCDIR, PCLSRCDIRにパスを設定．（<a target="_blank" rel="noopener" href="https://gitlab.com/pixinsight/PCL/">こちら</a>を参考に）<br>Visual Studio 2019 を開き，\PCL\src\pcl\windows\vc16\PCL.vcxproj を開く．ビルドの設定をRelease, x64にします．そのままやるとこの後エラーが出るので，以下のコードをちょっと修正しました．</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DrizzleData.cpp 481行目あたり，</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( element.<span class="built_in">Name</span>() == <span class="string">&quot;CFASourceImage&quot;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// optional</span></span><br><span class="line">    m_cfaSourceFilePath = element.<span class="built_in">Text</span>().<span class="built_in">Trimmed</span>();</span><br><span class="line">    m_cfaSourcePattern = element.<span class="built_in">AttributeValue</span>( <span class="string">&quot;pattern&quot;</span> );</span><br><span class="line">    String channel = element.<span class="built_in">AttributeValue</span>( <span class="string">&quot;channel&quot;</span> );</span><br><span class="line">    <span class="keyword">if</span> ( !channel.<span class="built_in">IsEmpty</span>() )</span><br><span class="line">      <span class="comment">//intへのキャストを追加，たぶんオーバーロードがうまくいってない</span></span><br><span class="line">      m_cfaSourceChannel = <span class="built_in">Range</span>( (<span class="type">int</span>)channel.<span class="built_in">ToInt</span>(), <span class="number">-1</span>, int32_max );</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>コンパイラによってはうまく動くのかもしれませんが，少なくとも自分の環境では無理でしたので，今のとここのような修正になっています．<br>ビルドすると，PCLLIBDIR64 に設定したパスにスタティックライブラリができます．</p>
<p><img src="/02.jpg" alt="PCLのスタティックライブラリができた！"></p>
<h4 id="C-側のインタフェースを用意，PCL-とリンク，Rust-バインディングの自動生成"><a href="#C-側のインタフェースを用意，PCL-とリンク，Rust-バインディングの自動生成" class="headerlink" title="C++ 側のインタフェースを用意，PCL とリンク，Rust バインディングの自動生成"></a>C++ 側のインタフェースを用意，PCL とリンク，Rust バインディングの自動生成</h4><p>次に，C++ 側のインタフェースを用意します．</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pcl_cpp.hpp</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pcl_rs</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Pcl_rs</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print_pcl_version</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pcl_cpp.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __PCL_WINDOWS</span></span><br><span class="line"><span class="comment">// include the local headers</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pcl/Version.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pcl_cpp.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line">Pcl_rs::<span class="built_in">Pcl_rs</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Pcl_rs::print_pcl_version</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">//ここでpclの機能を実際に呼んでます</span></span><br><span class="line">  std::cout &lt;&lt; pcl::Version::<span class="built_in">AsString</span>() &lt;&lt; std::endl;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pcl_cpp.cpp は CMake を使ってビルドするので，CMakeList.txtを用意します．</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#CMakeList.txt</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(pcl_cpp)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(<span class="keyword">TARGET</span> pcl_cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment">#自身の環境によって変更してください</span></span><br><span class="line"><span class="keyword">include_directories</span>(/path/to/PCLINCDIR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;TARGET&#125;</span></span><br><span class="line">  STATIC</span><br><span class="line">    pcl_cpp.cpp</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;TARGET&#125;</span></span><br><span class="line">  PRIVATE</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">install</span> (TARGETS <span class="variable">$&#123;TARGET&#125;</span> DESTINATION .)</span><br></pre></td></tr></table></figure>

<p>Rust の ライブラリプロジェクトを用意します．これが本番アプリケーションという体です．<br>ライブラリプロジェクトなので，別のプログラムに移植することは簡単です．</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo new pcl-rs --lib //ライブラリプロジェクトを作る</span><br></pre></td></tr></table></figure>

<p>上に書いた3つを以下のように配置します．</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├─pcl-rs</span><br><span class="line">│  │  build.rs</span><br><span class="line">│  │  Cargo.toml</span><br><span class="line">│  │</span><br><span class="line">│  ├─src</span><br><span class="line">│  │  │  lib.rs</span><br><span class="line">│  │  │  main.rs</span><br><span class="line">│  │  │  </span><br><span class="line">│  │  └─pcl_cpp</span><br><span class="line">│  │          CMakeLists.txt</span><br><span class="line">│  │          pcl_cpp.cpp</span><br><span class="line">│  │          pcl_cpp.hpp</span><br></pre></td></tr></table></figure>
<p>触れていないファイルがいつかありますが後述します．<br>build.rs が 本番アプリケーションのビルド時に走るスクリプトです．ここでCMake，bindgenを使って，Rust から pcl_cpp.cpp の機能を使えるようにします．<br>まず Cargo.toml に依存ライブラリを記載．</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">libc</span> = <span class="string">&quot;0.2.51&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[build-dependencies]</span></span><br><span class="line"><span class="attr">cc</span> = <span class="string">&quot;1.0.35&quot;</span></span><br><span class="line"><span class="attr">bindgen</span> = <span class="string">&quot;0.52&quot;</span></span><br><span class="line"><span class="attr">libc</span> = <span class="string">&quot;0.2.51&quot;</span></span><br><span class="line"><span class="attr">cmake</span> = <span class="string">&quot;0.1&quot;</span></span><br></pre></td></tr></table></figure>

<p>ビルドスクリプトを書いていきます．</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//build.rs</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> bindgen;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> cmake;</span><br><span class="line"><span class="keyword">use</span> std::env;</span><br><span class="line"><span class="keyword">use</span> std::path::PathBuf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">//pcl_cpp.cppかpcl_hpp.cppが変更された場合に走る</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-changed=src/pcl_cpp/pcl_cpp.cpp&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rerun-if-changed=src/pcl_cpp/pcl_cpp.hpp&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="variable">out_path</span> = PathBuf::<span class="title function_ invoke__">from</span>(env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;OUT_DIR&quot;</span>).<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">out_path</span> = out_path.<span class="title function_ invoke__">to_str</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//リンクするライブラリを探すパス</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-search=&#123;&#125;/build/Release/&quot;</span>, out_path);</span><br><span class="line">    <span class="comment">//自身の環境によって変更してください</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-search=native=/path/to/PCLLIBDIR64&quot;</span>);</span><br><span class="line">    <span class="comment">//Windows でビルドする場合に必要</span></span><br><span class="line">    <span class="comment">//User32.Lib の場所を指定</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-search=native=C:/Program Files (x86)/Windows Kits/10/Lib/10.0.19041.0/um/x64&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//リンクするライブラリ</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=static=pcl_cpp&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=static=PCL-pxi&quot;</span>);</span><br><span class="line">    <span class="comment">//Windows でビルドする場合に必要</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;cargo:rustc-link-lib=static=User32&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">out_path</span> = PathBuf::<span class="title function_ invoke__">from</span>(env::<span class="title function_ invoke__">var</span>(<span class="string">&quot;OUT_DIR&quot;</span>).<span class="title function_ invoke__">unwrap</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_dst</span> = cmake::Config::<span class="title function_ invoke__">new</span>(<span class="string">&quot;src/pcl_cpp&quot;</span>).<span class="title function_ invoke__">generator</span>(<span class="string">&quot;Visual Studio 16 2019&quot;</span>).<span class="title function_ invoke__">build</span>(); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//pcl_cpp.hpp からバインディング生成</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bindings</span> = bindgen::Builder::<span class="title function_ invoke__">default</span>()</span><br><span class="line">        .<span class="title function_ invoke__">clang_arg</span>(<span class="string">&quot;-x&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">clang_arg</span>(<span class="string">&quot;c++&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">header</span>(<span class="string">&quot;src/pcl_cpp/pcl_cpp.hpp&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">parse_callbacks</span>(<span class="type">Box</span>::<span class="title function_ invoke__">new</span>(bindgen::CargoCallbacks))</span><br><span class="line">        .<span class="title function_ invoke__">generate</span>()</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Unable to generate bindings&quot;</span>);</span><br><span class="line"></span><br><span class="line">    bindings</span><br><span class="line">        .<span class="title function_ invoke__">write_to_file</span>(out_path.<span class="title function_ invoke__">join</span>(<span class="string">&quot;pcl_cpp.rs&quot;</span>))</span><br><span class="line">        .<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Couldn&#x27;t write bindings!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>スクリプトの細かい説明は省きますが，ビルドスクリプトが走ると，OUT_DIR で設定されたパス以下に pcl_cpp.rs バインディングが自動生成されます．<br>ここに，C++側のクラス，メソッドの情報などが入っています．</p>
<h4 id="Rust-の本番アプリケーションから呼出し"><a href="#Rust-の本番アプリケーションから呼出し" class="headerlink" title="Rust の本番アプリケーションから呼出し"></a>Rust の本番アプリケーションから呼出し</h4><p>あとは Rust 側のライブラリでこのバインディングを読み込めばOKです．<br>lib.rs に以下を書いて，</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lib.rs</span></span><br><span class="line"><span class="meta">#![allow(non_upper_case_globals)]</span></span><br><span class="line"><span class="meta">#![allow(non_camel_case_types)]</span></span><br><span class="line"><span class="meta">#![allow(non_snake_case)]</span></span><br><span class="line"><span class="meta">#![allow(dead_code)]</span></span><br><span class="line">include!(<span class="built_in">concat!</span>(<span class="built_in">env!</span>(<span class="string">&quot;OUT_DIR&quot;</span>), <span class="string">&quot;/pcl_cpp.rs&quot;</span>));</span><br><span class="line"><span class="comment">//自動生成されたバインディングを読み込む</span></span><br></pre></td></tr></table></figure>

<p>main アプリケーションで実際に使ってみます．</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.rs</span></span><br><span class="line"><span class="keyword">use</span> pcl_rs::Pcl_rs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">  <span class="comment">//本番アプリケーションではこのように unsafe ブロックで囲んで使う</span></span><br><span class="line">  <span class="keyword">unsafe</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">my_pcl</span> = Pcl_rs::<span class="title function_ invoke__">new</span>();</span><br><span class="line">      my_pcl.<span class="title function_ invoke__">print_pcl_version</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Rust でビルドすると…</p>
<p><img src="/03.jpg" alt="PCL のバージョンが出た！"></p>
<p>Rust で作ったライブラリから PCL を呼び出して，バージョンが出ました！めでたしめでたし．</p>
<h3 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h3><p>まだ PCL でどれだけのことができるのかわかっていませんが，Rust 側とのデータのコミュニケーションができれば，PCL で提供されている数多くの機能を自作プログラムから呼び出して利用することができるようになりました．<br>これは実質 PixInsight のすべての力を手に入れたと言っても過言ではない…？<br>今回のテクニックは，PCL 以外にも C++ で書かれたライブラリを利用する時に有用です．<br>また何か発展があればブログに書きたいと思います！<br>それでは．</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2021/11/10/00000059-toa130ns/" title="【やってしまった！】TOA-130NS 導入の裏？話"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: 【やってしまった！】TOA-130NS 導入の裏？話</span></a><a class="button is-default" href="/2021/06/27/00000057-douga-01/" title="動画投稿デビュー（のちょっと裏話）"><span class="has-text-weight-semibold">Next: 動画投稿デビュー（のちょっと裏話）</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="dabokun/dabokun.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/astrodabo"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/dabokun"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> dabokun 2025</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>