<!DOCTYPE html><html class="appearance-auto" lang="en"><head><meta charset="UTF-8"><title>ほしよみ社会塵のブログ</title><meta name="description" content="やっていきます"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/avatar.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="あいさつこんにちは．先日行ったあいあい岬で撮影したアンタレス付近を編集していて，こんなことをやってみましたので，その紹介記事です．


モチベーションTwitterでフォローしているnagahiroさんのこちらの記事を見て，初めて”Ringing”という名前がついていることを知ったのですが，これは天体写真を編集しているとよくある現象です．例えば，Ps，Lrの「明るさの最小値」やSI8の「スターシャープ」をかけて星雲を強調していると，微光星の周りが暗く落ち込んでしまうということがよく起きます．画面上で見たり小さい写真用紙に印刷する時はあまり気になりませんが，A4写真用紙等に印刷すると主に星雲の中でかなり気になるレベルで影響が出てきます（僕の場合だけかもしれませんが笑）．これをなんとかしたいというのが今回のモチ.."><meta property="og:url" content="http://dabokun.github.io/2019/05/18/00000007-suitably-star-enhance/"><meta property="og:title" content="ほしよみ社会塵のブログ"><meta property="og:type" content="article"><meta property="og:description" content="あいさつこんにちは．先日行ったあいあい岬で撮影したアンタレス付近を編集していて，こんなことをやってみましたので，その紹介記事です．"><meta property="name" content="あいさつこんにちは．先日行ったあいあい岬で撮影したアンタレス付近を編集していて，こんなことをやってみましたので，その紹介記事です．"><meta property="og:image" content="http://dabokun.github.io/null"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@astrodabo"><meta property="og:site_name" content="ほしよみ社会塵のブログ"><meta property="og:locale" content="ja_JP"><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="ほしよみ社会塵のブログ" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">ほしよみ社会塵のブログ</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">よしなにスターエンハンスしてみる</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Click back to the top</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">Home</a></h3><h3 class="is-inline-block"><a href="/about">About</a></h3><h3 class="is-inline-block"><a href="/archives">Archives</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%81%82%E3%81%84%E3%81%95%E3%81%A4"><span class="toc-text">あいさつ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%83%A2%E3%83%81%E3%83%99%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3"><span class="toc-text">モチベーション</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E6%B3%95"><span class="toc-text">手法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0"><span class="toc-text">プログラム</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B5%90%E6%9E%9C"><span class="toc-text">結果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%97%E3%82%89%E3%82%8C%E3%81%9F%E7%9F%A5%E8%A6%8B%E3%81%A8%E6%84%9F%E6%83%B3"><span class="toc-text">得られた知見と感想</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E5%A4%A9%E4%BD%93%E5%86%99%E7%9C%9F"><i class="tag post-item-tag">天体写真</i></a><a href="/tags/%E7%94%BB%E5%83%8F%E5%87%A6%E7%90%86"><i class="tag post-item-tag">画像処理</i></a><a href="/tags/OpenCV"><i class="tag post-item-tag">OpenCV</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">よしなにスターエンハンスしてみる</h1><time class="has-text-grey" datetime="2019-05-18T10:18:56.000Z">2019-05-18</time><article class="mt-2 post-content"><h3 id="あいさつ"><a href="#あいさつ" class="headerlink" title="あいさつ"></a>あいさつ</h3><p>こんにちは．先日行ったあいあい岬で撮影したアンタレス付近を編集していて，こんなことをやってみましたので，その紹介記事です．</p>
<span id="more"></span>

<h3 id="モチベーション"><a href="#モチベーション" class="headerlink" title="モチベーション"></a>モチベーション</h3><p>Twitterでフォローしている<a target="_blank" rel="noopener" href="https://twitter.com/pochomskii">nagahiro</a>さんの<a target="_blank" rel="noopener" href="http://snct-astro.hatenadiary.jp/entry/2019/05/16/083952">こちら</a>の記事を見て，初めて”Ringing”という名前がついていることを知ったのですが，これは天体写真を編集しているとよくある現象です．例えば，Ps，Lrの「明るさの最小値」やSI8の「スターシャープ」をかけて星雲を強調していると，微光星の周りが暗く落ち込んでしまうということがよく起きます．画面上で見たり小さい写真用紙に印刷する時はあまり気になりませんが，A4写真用紙等に印刷すると主に星雲の中でかなり気になるレベルで影響が出てきます（僕の場合だけかもしれませんが笑）．これをなんとかしたいというのが今回のモチベーションになります．</p>
<h3 id="手法"><a href="#手法" class="headerlink" title="手法"></a>手法</h3><p>nagahiroさんはこれをハイパスを使って，かなりうまく補正していますね．私はそういった前提知識がなかったので，別の方法を考えてみました．具体的には以下の通りです．</p>
<ul>
<li>星雲の中の微光星を見た時，その輝度や彩度は内側から「微光星（めっちゃ明るい，彩度低）」→「Ringing（暗い，彩度低）」→「星雲（微光星ほどではないが明るく，かつ彩度が高い）」のようになっている，という仮定をおきます．</li>
<li>よって，テキトーなフィルタを使って周辺の画素を使って埋めてやる（何回か繰り返す）．</li>
<li>具体的にはRingingが起こっている画素を中心とした5×5のフィルタで，彩度が高い画素トップ9くらいを選んで，その平均をとってやる．<br><img src="/images/00000007-suitably-star-enhance/filter.jpg"><br>例えばこんな感じの5×5の並びがあった時に，Ringing Pixelは星雲あたりの黄色っぽい画素を使って置き換えてやればいい感じになるんじゃないかな？というアイデアです．</li>
</ul>
<p>とまあこんな感じになります．それでは実装していきます．</p>
<h3 id="プログラム"><a href="#プログラム" class="headerlink" title="プログラム"></a>プログラム</h3><p>実装にはC++（Visual Studio 2017に入ってるコンパイラ）とOpenCVを使います．OpenCVの導入については「<a target="_blank" rel="noopener" href="https://qiita.com/h-adachi/items/aad3401b8900438b2acd">OpenCV 4.1.0をVisual Studio 2019から使用する時の手順</a>」あたりを参考にどうぞ．</p>
<pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdafx.h&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> cv;

<span class="hljs-meta">#<span class="hljs-keyword">define</span> INF 10000000</span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span></span>
<span class="hljs-function"></span>&#123;
    string filename = <span class="hljs-string">&quot;input.tif&quot;</span>;
    Mat image = <span class="hljs-built_in">imread</span>(filename, <span class="hljs-number">2</span> | <span class="hljs-number">4</span>);
    
    <span class="hljs-comment">//画像読込み</span>
    <span class="hljs-keyword">if</span> (image.data == <span class="hljs-literal">NULL</span>) &#123; 
        cerr &lt;&lt; <span class="hljs-string">&quot;Error: Couldn&#x27;t read file &quot;</span> &lt;&lt; filename &lt;&lt; endl;
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    &#125;
	
    <span class="hljs-type">int</span> xsize = image.cols;
    <span class="hljs-type">int</span> ysize = image.rows;
    <span class="hljs-type">int</span> th = <span class="hljs-number">10000</span>; <span class="hljs-comment">//輝度のスレッショルド</span>

    Mat output = Mat::<span class="hljs-built_in">zeros</span>(ysize, xsize, CV_16UC3); <span class="hljs-comment">//16bit tifの場合こう</span>
    <span class="hljs-type">double</span> sat[<span class="hljs-number">5</span>][<span class="hljs-number">5</span>] = &#123; <span class="hljs-number">0.0</span> &#125;; <span class="hljs-comment">//彩度</span>
    <span class="hljs-type">int</span> rank[<span class="hljs-number">5</span>][<span class="hljs-number">5</span>] = &#123; <span class="hljs-number">0</span> &#125;; <span class="hljs-comment">//彩度のランク(大きいほど明るい)</span>
    ushort maxc, minc;
    maxc = -INF, minc = INF;

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> t = <span class="hljs-number">0</span>; t &lt; <span class="hljs-number">30</span>; t++) &#123; <span class="hljs-comment">//30回操作</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; ysize; j++) &#123;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; xsize; i++) &#123;
                <span class="hljs-keyword">if</span> (image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">0</span>] &lt; th  &amp;&amp; image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">1</span>] &lt; th &amp;&amp; image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">2</span>] &lt; th &amp;&amp; j &gt; <span class="hljs-number">2</span> &amp;&amp; i &gt; <span class="hljs-number">2</span> &amp;&amp; j &lt; ysize - <span class="hljs-number">2</span> &amp;&amp; i &lt; xsize - <span class="hljs-number">2</span>) &#123; <span class="hljs-comment">//Ringingが起きているなら</span>
                    <span class="hljs-type">int</span> lc, mc;
                    <span class="hljs-keyword">for</span> (lc = <span class="hljs-number">0</span>; lc &lt; <span class="hljs-number">5</span>; lc++) &#123;
                        <span class="hljs-keyword">for</span> (mc = <span class="hljs-number">0</span>; mc &lt; <span class="hljs-number">5</span>; mc++) &#123;
                            rank[lc][mc] = <span class="hljs-number">0</span>;
                        &#125;
                    &#125;
                    lc = mc = <span class="hljs-number">0</span>;
                    <span class="hljs-comment">// 周辺画素の彩度を計算</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> l = j - <span class="hljs-number">2</span>; l &lt;= j + <span class="hljs-number">2</span>; l++) &#123;
                        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> m = i - <span class="hljs-number">2</span>; m &lt;= i + <span class="hljs-number">2</span>; m++) &#123;
                            maxc = <span class="hljs-built_in">max</span>(image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(l, m)[<span class="hljs-number">0</span>], image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(l, m)[<span class="hljs-number">1</span>]);
                            minc = <span class="hljs-built_in">min</span>(image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(l, m)[<span class="hljs-number">0</span>], image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(l, m)[<span class="hljs-number">1</span>]);
                            maxc = <span class="hljs-built_in">max</span>(maxc, image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(l, m)[<span class="hljs-number">2</span>]);
                            minc = <span class="hljs-built_in">min</span>(minc, image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(l, m)[<span class="hljs-number">2</span>]);
                            sat[lc][mc] = maxc == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : ((<span class="hljs-type">double</span>)(maxc - minc) / (<span class="hljs-type">double</span>)maxc);
                            mc++;
                        &#125;
                        lc++;
                        mc = <span class="hljs-number">0</span>;
                        maxc = -INF, minc = INF;
                    &#125;
                    <span class="hljs-comment">// 彩度でランキング</span>
                    <span class="hljs-keyword">for</span> (lc = <span class="hljs-number">0</span>; lc &lt; <span class="hljs-number">5</span>; lc++) &#123;
                        <span class="hljs-keyword">for</span> (mc = <span class="hljs-number">0</span>; mc &lt; <span class="hljs-number">5</span>; mc++) &#123;
                            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> lcc = <span class="hljs-number">0</span>; lcc &lt; <span class="hljs-number">5</span>; lcc++) &#123;
                                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> mcc = <span class="hljs-number">0</span>; mcc &lt; <span class="hljs-number">5</span>; mcc++) &#123;
                                    <span class="hljs-keyword">if</span> (!(lc == lcc &amp;&amp; mc == mcc) &amp;&amp; sat[lc][mc] &gt; sat[lcc][mcc]) &#123;
                                        rank[lc][mc]++;
                                    &#125;
                                &#125;
                            &#125;
                        &#125;
                    &#125;

                    lc = mc = <span class="hljs-number">0</span>;
                    <span class="hljs-comment">// フィルタを使って，周辺画素から置換</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> l = j - <span class="hljs-number">2</span>; l &lt;= j + <span class="hljs-number">2</span>; l++) &#123;
                        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> m = i - <span class="hljs-number">2</span>; m &lt;= i + <span class="hljs-number">2</span>; m++) &#123;
                            <span class="hljs-keyword">if</span> (rank[lc][mc] &gt;= <span class="hljs-number">16</span>) &#123;
                                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">3</span>; k++) &#123;
                                    output.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[k] += image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(l, m)[k] / <span class="hljs-number">9</span>;
                                &#125;
                            &#125;
                            mc++;
                        &#125;
                        mc = <span class="hljs-number">0</span>;
                        lc++;
                    &#125;
                &#125;<span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//Ringingが起きていなければ無視</span>
                    output.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">0</span>] = image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">0</span>];
                    output.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">1</span>] = image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">1</span>];
                    output.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">2</span>] = image.<span class="hljs-built_in">at</span>&lt;Vec3w&gt;(j, i)[<span class="hljs-number">2</span>];
                &#125;
            &#125;
        &#125;
    &#125;
    <span class="hljs-built_in">imwrite</span>(<span class="hljs-string">&quot;output.tif&quot;</span>, output);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;
</code></pre>
<h3 id="結果"><a href="#結果" class="headerlink" title="結果"></a>結果</h3><p>結果は冒頭のツイートの通りで，落込みの完全解消までには至りませんでしたが，SI8のスターエンハンスに比べ，微光星の主張が激しすぎず，かつ周辺の彩度を保ったまま落込みを補完することができたんじゃないかなあと思います．画面上ではあまり違いが分かりませんが，この後少し微調整して印刷したところ，Ringingに見られるぼつぼつがある程度解消され，かなり有効だということがわかりました．</p>
<p>処理前<br><img src="/images/00000007-suitably-star-enhance/beforeprocess.jpg"></p>
<p>処理後<br><img src="/images/00000007-suitably-star-enhance/afterprocess.jpg"></p>
<p>いかがでしょうか，黒く落ちすぎている部分が，周りの星雲の色でもって塗られていることがわかりますね．</p>
<h3 id="得られた知見と感想"><a href="#得られた知見と感想" class="headerlink" title="得られた知見と感想"></a>得られた知見と感想</h3><p>プログラムについてですが，16bit tiff形式を読書きするやり方がわからず少し時間を使いました．imreadの引数や行列の定義はプログラムの通りですし，画素へのアクセスはimage.at&lt;Vec3w&gt;(y, x)[k]</code>でいけるっぽいです．<br>上記のプログラムで何回か(30回)フィルタをかませていますが，繰り返してもあまり意味がありませんでした．それと，今回は輝度だけでRingingが起きている画素かを判断していて，これはよくないですね．例えば暗黒星雲をRingingが起きている画素と判断し，暗黒星雲のある部分だけ明るくなってしまうということが起きました（以下画像参照）．<br><img src="/images/00000007-suitably-star-enhance/effect_to_dark_nebula.jpg"></p>
<p>ハイパスを使ったやり方も楽しそうなので，原理を勉強しつつ今後実装したいと考えています．</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2019/05/28/00000008-suitably-corner-make/" title="よしなに画像の四隅を切り出してみる"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">Previous: よしなに画像の四隅を切り出してみる</span></a><a class="button is-default" href="/2019/05/11/hello/" title="ブログを移行します &amp; はじめまして"><span class="has-text-weight-semibold">Next: ブログを移行します &amp; はじめまして</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="dabokun/dabokun.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com/astrodabo"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/dabokun"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> dabokun 2025</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>